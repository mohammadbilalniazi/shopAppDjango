{% extends "master.html" %}
{% load jalali_tags static %}

{% block title %}{% if bill %}Update Bill{% else %}Add Bill{% endif %} | Shirkat{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
<link rel="stylesheet" href="{% static 'admin/css/forms.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/toastr.min.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/common.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/fontawesome.min.css' %}">
<!-- Select2 CSS for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% if form %}{{ form.media.css }}{% endif %}
<style>
        .danger-btn{
            font-weight: 900; 
            font-size: 16px; 
            background-color: red; 
            color: black; 
            padding: 0px; 
            margin: 0px;
            padding:0.4%;
        }
        .bill_creator{
            font-size:xx-large;
            font-weight: 900;
            color:black
        }
        .bill_acceptor{
            font-size:xx-large;
            font-weight: 900;
            color:crimson
        }

    select {
        font-weight: 900;
    }
    input[type=number], input[type=text] {
        font-weight: 900;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    table th, table td {
        padding: 8px;
        text-align: left;
        border: 1px solid #ddd;
    }
    table thead th {
        background-color: #f2f2f2;
        font-weight: bold;
        border: 2px solid #999;
        padding: 10px;
    }
    table tbody td {
        border: 1px solid #ddd;
    }
    .form-table {
        background: white;
        padding: 20px;
        border-radius: 5px;
    }
    .submit-row {
        margin-top: 20px;
        padding: 10px;
        text-align: center;
    }
    /* Select2 custom styling */
        .select2-container {
            font-weight: 900;
        }
        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 30px;
            color: #333;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        .select2-dropdown {
            border: 1px solid #ced4da;
            font-weight: 900;
        }
    .select2-search__field {
        border: 1px solid #ced4da;
        padding: 4px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 20px auto; padding: 20px;">
    
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == "error" %}
                <div class='alert alert-danger' style="background-color:rgb(176, 122, 122);font-weight:bolder;text-align:center;padding:12px;font-size:15px">
            {% else %}
                <div class='alert alert-success' style="background-color:lightgreen;font-weight:bolder;text-align:center;padding:12px;font-size:15px">
            {% endif %}
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <input type="hidden" id="detail_or_update" value="{% if bill %}1{% else %}0{% endif %}">
    
    <form method="post" action="{{ request.META.HTTP_NAME }}/receive_payment/bill/save/" id="bill">                 
        {% csrf_token %}
        
        <!-- Main Bill Information Table -->
        <div class="form-table">
            <table>
                <tr class="bill_creator">
                    <td>Bill Creator Organization</td>
                    <td>
                        <span style="display:inline;margin:3%">
                            <select type="text" name="organization" id="organization">
                                <option {% if bill.organization %}value="{{ bill.organization.id }}"{% else %}value="{{ organization.id }}"{% endif %}>
                                    {% if bill %}{{ bill.organization }}{% else %}{{ organization }}{% endif %}
                                </option>
                            </select>
                        </span>
                    </td>
                </tr> 
                <tr class="bill_creator">
                    <td >
                        Bill type
                    </td>
                    <td>
                        <span  > 
                            <select type="text" name="bill_type"  value="{{bill.bill_type}}"   required="" id="bill_type">     
                                <option {% if bill %} {% if bill.bill_type == 'PAYMENT' %} selected {% endif %} {% endif %} value="PAYMENT">PAYMENT</option>
                                <option {% if bill %} {% if bill.bill_type == 'RECEIVEMENT' %} selected {% endif %} {% endif %} value="RECEIVEMENT">RECEIVEMENT</option>                               
                            </select>   
                        </span>
                    </td>
                    
                    <td>Bill Creator User</td>
                    <td>     
                        <span style="display:inline;margin:3%">                   
                            <input type="text" disabled name="creator" {% if bill %} value="{{bill.creator}}" {% else %}  value="{{user.username}}" {% endif %} placeholder="creator"  class="" required="" id="creator">     
                        </span>  
                    </td>
                    <!-- </span>  -->
                    <td> 
                        <!-- style="float:right;display:inline;font-size:x-large;font-weight: 900;color:darkred"  -->
                    <span>System Bill ID 
                    </span>
                    </td>
                    <td>
                        <input type="number"  value="{{bill.id}}" disabled name="bill_id" id="bill_id" >
                    </td>
                </tr>
            
                    <tr class="bill_creator">
                         <td>
                             bill No 
                        </td>    
                        <td>                                       
                            <span > 
                            <input type="number"  name="bill_no" id="bill_no"  {% if bill.bill_no %} value="{{bill.bill_no}}" {% else %} value="{{bill_no}}" {% endif %} placeholder="بل شمیره" class="" required="" >                      
                          
                            </span> 
                        </td>
                        
                        <td>
                            Date
                        </td>
                        <td>
                            <span style="display:inline;margin:1%">
                                        {{form.date}}                              
                            </span>
                        </td>
                        
                    </tr>  
                    <tr class="bill_creator">    
                        
                        <td>
                            Bill Status
                        </td>
                        <td>
                            <span style="display:inline;margin:3%">
                            <input type="checkbox" {% if bill.bill_receiver2.is_approved %} checked {% endif %}  name="is_approved" id="is_approved">

                            <select name="status" placeholder="status"  required id="status">     
                                <option value="0" {% if bill.status == 0 %} selected {% endif %}>CREATED </option>    
                                <option value="1" {% if bill.status == 1 %} selected {% endif %}>APPROVED</option>  
                                <option value="2" {% if bill.status == 2 %} selected {% endif %}>REVERSED</option>
                                <option value="3" {% if bill.status == 3 %} selected {% endif %}>REJECTED</option>
                            </select>
                            </span>
                        </td>
                         <td>
                            Total Bill 
                        </td>
                        <td>
                            <span style="display:inline;margin:3%">
                                <input type="number" id="total" name="total" disabled  value="{{bill.total}}" placeholder="مجموعه پیسی"   >                      
                            </span>   
                        </td> 
                        
                        
                        <td>Payment/Receivement</td>
                        <td>
                            <span style="display:inline;margin:3%">
                                        <input type="number" name="total_payment" {% if bill %} value="{{bill.payment}}"  {% else %} value="0" {% endif %} placeholder="مجموعه ادا" required="" id="total_payment"  min="0"  step="0.0001">                      
                            </span>
                        </td>
                    </tr>
                    <tr class="bill_acceptor" >
                        <td>
                           Bill Receiver Organization
                        </td> 
                        <td>              
                            <span style="display:flex; align-items:center; gap:5px;" id="rcvr_org_span">
                                <select type="text"  name="bill_rcvr_org" placeholder="مقابل لوری" class="" required="" id="bill_rcvr_org" style="flex:1;">     
                                    {% for row in rcvr_orgs %}
                                    <option  {% if bill.bill_receiver2.bill_rcvr_org == row %} selected  {% endif %} value="{{row.id}}">{{row}}</option>
                                    {% endfor %}
                                </select>     
                                <button type="button" id="add_org_modal_btn" onclick="openOrganizationModal()" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 16px; min-width: 40px;" title="Add New Organization">+</button>                       
                            </span>
                        </td>
                       
                    </tr> 
                    <tr class="bill_acceptor">
                        <td>
                            Approval User
                        </td>
                        <td>
                            <span style="display:inline;margin:3%">
                            <input type="text" name="approval_user" value="{{bill.bill_receiver2.approval_user}}"  placeholder="approval_user " disabled id="approval_user" >                      
                            </span>
                        </td>
                        <td>
                            Approval Date
                        </td>
                        <td>
                            <span style="display:inline;margin:3%">
                                <input type="text" name="approval_date"  placeholder="approval_date" value="{{bill.bill_receiver2.approval_date}}" disabled  id="approval_date" >                      
                            </span>
                        </td>
                    </tr>     
                    </table>
                    <div id="content-main">
                                <div>
                                    
                                    <div class="submit-row">

                                        {% if bill %}
                                        
                                        <input type="submit" value="Update" style="background-color:green; color:white" class="default" name="_save">
                                        {% else %}
                                        <input type="submit" value="Save" class="default" name="_save">
                                        {% endif %}
                                        <!-- {% if bill %}
                                        <a href="/bill/delete/{{bill.id}}/" role="button" class="danger-btn" style="background-color:red; color:white" >delete</a>
                                        {% endif %}     -->
                                    </div> 
                            </div>
                        </form>
                   
                </div>  <!--end of div content-main-->
            </div>
        </form>
    </div>
</div>

<!-- ========== ORGANIZATION MODAL ========== -->
<div id="organizationModal" class="product-modal" style="display: none;">
    <div class="product-modal-content" style="max-width: 700px;">
        <div class="product-modal-header" style="background-color: #417690; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Add New Organization</h2>
            <span class="organization-modal-close" style="cursor: pointer; font-size: 28px;">&times;</span>
        </div>
        <div class="product-modal-body" style="padding: 20px;">
            <form id="modal_organization_form">
                {% csrf_token %}
                
                <table style="width: 100%;">
                    <tr>
                        <td style="width: 35%; padding: 10px;"><label for="modal_org_owner">Owner User Name: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="owner" id="modal_org_owner" maxlength="10" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_org_type">Organization Type: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;">
                            <select name="type" id="modal_org_type" class="form-control" required style="width: 100%;">
                                <option value="SHIRKAT">SHIRKAT</option>
                                <option value="SHOP">SHOP</option>
                                <option value="NONE">NONE</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_org_name">Shirkat/Shop Name: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="name" id="modal_org_name" maxlength="20" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_org_email">Email: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="email" class="form-control" name="email" id="modal_org_email" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_org_password">Password: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="password" class="form-control" name="password" id="modal_org_password" value="Afghan123" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_org_location">Location: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px; display: flex; gap: 5px;">
                            <select name="location" id="modal_org_location" class="form-control" required style="flex: 1;"></select>
                            <button type="button" class="btn btn-sm" onclick="openLocationModal()" style="background-color: #417690; color: white; padding: 5px 15px;" title="Add Location">+</button>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_org_is_active">Is Active:</label></td>
                        <td style="padding: 10px;"><input type="checkbox" name="is_active" id="modal_org_is_active" checked></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right; padding: 20px 10px 10px;">
                            <button type="button" class="btn" onclick="closeOrganizationModal()" style="margin-right: 10px; padding: 8px 20px;">Cancel</button>
                            <button type="submit" class="btn btn-primary" style="background-color: green; color: white; padding: 8px 20px;">Save Organization</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>

<!-- ========== LOCATION MODAL ========== -->
<div id="locationModal" class="product-modal" style="display: none;">
    <div class="product-modal-content" style="max-width: 500px;">
        <div class="product-modal-header" style="background-color: #417690; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Add New Location</h2>
            <span class="location-modal-close" style="cursor: pointer; font-size: 28px;">&times;</span>
        </div>
        <div class="product-modal-body" style="padding: 20px;">
            <form id="modal_location_form">
                {% csrf_token %}
                
                <table style="width: 100%;">
                    <tr>
                        <td style="width: 35%; padding: 10px;"><label for="modal_location_country">Country: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px; display: flex; align-items: center; gap: 5px;">
                            <select class="form-control" name="country" id="modal_location_country" required style="flex: 1;"></select>
                            <button type="button" onclick="openCountryModal()" class="btn btn-sm btn-success" style="padding: 5px 10px; background-color: green; color: white; border: none; cursor: pointer; border-radius: 3px;" title="Add new country">+</button>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_location_state">State/Province: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="state" id="modal_location_state" maxlength="20" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_location_city">City: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="city" id="modal_location_city" maxlength="20" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right; padding: 20px 10px 10px;">
                            <button type="button" class="btn" onclick="closeLocationModal()" style="margin-right: 10px; padding: 8px 20px;">Cancel</button>
                            <button type="submit" class="btn btn-primary" style="background-color: green; color: white; padding: 8px 20px;">Save Location</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>

<!-- Country Modal (nested within Location Modal) -->
<div id="countryModal" class="product-modal" style="display: none; z-index: 10002;">
    <div class="product-modal-content" style="width: 400px; max-width: 90%;">
        <span class="product-modal-close country-modal-close">&times;</span>
        <div class="product-modal-header">
            <h2 style="color: white; margin: 0;">Add New Country</h2>
        </div>
        <div class="product-modal-body" style="padding: 20px;">
            <form id="modal_country_form">
                {% csrf_token %}
                
                <table style="width: 100%;">
                    <tr>
                        <td style="width: 35%; padding: 10px;"><label for="modal_country_name">Country Name: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="name" id="modal_country_name" maxlength="20" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_country_shortcut">Shortcut: <span style="color:red">*</span></label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="shortcut" id="modal_country_shortcut" maxlength="5" required style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><label for="modal_country_currency">Currency:</label></td>
                        <td style="padding: 10px;"><input type="text" class="form-control" name="currency" id="modal_country_currency" maxlength="5" value="Afg" style="width: 100%;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right; padding: 20px 10px 10px;">
                            <button type="button" class="btn" onclick="closeCountryModal()" style="margin-right: 10px; padding: 8px 20px;">Cancel</button>
                            <button type="submit" class="btn btn-primary" style="background-color: green; color: white; padding: 8px 20px;">Save Country</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
{{ form.media }}
<!-- Select2 JS for searchable dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="{% static 'assets/js/toastr.min.js' %}"></script>
<script src="{% static 'assets/js/axios.min.js' %}"></script>
<script src="{% static 'assets/js/cookie.js' %}"></script>
<script src="{% static 'assets/js/common_entities/call_shirkat.js' %}"></script>
<script src="{% static 'assets/js/common_entities/create_element.js' %}"></script>
<script src="{% static 'assets/js/show_message.js' %}"></script>
<script src="{% static 'assets/js/bill/bill_delete.js' %}"></script>
<script src="{% static 'assets/js/bill/organization_location_modal.js' %}"></script>
<script src="{% static 'assets/js/bill/receive_payment_bill.js' %}"></script>
<script src="{% static 'assets/js/bill/select_bill_no.js' %}"></script>
<!-- Searchable Selects Module -->
<script src="{% static 'assets/js/bill/searchable_selects.js' %}"></script>

<script>
// Remove Django admin's auto-generated addlink that navigates to /admin/
// And ensure our custom button stays in place
(function() {
    function ensureOrganizationButton() {
        const rcvrOrgSpan = document.getElementById('rcvr_org_span');
        if (!rcvrOrgSpan) return;
        
        // Remove any Django admin addlinks
        const adminAddlinks = rcvrOrgSpan.querySelectorAll('a.addlink[href*="/admin/"]');
        adminAddlinks.forEach(link => {
            console.log('Removing Django admin addlink:', link);
            link.remove();
        });
        
        // Check if our custom button exists using a unique ID
        const existingButton = document.getElementById('add_org_modal_btn');
        if (!existingButton) {
            console.log('Custom organization button missing, adding it back...');
            
            // Create our custom button
            const button = document.createElement('button');
            button.id = 'add_org_modal_btn'; // Unique ID to identify our button
            button.type = 'button';
            button.onclick = function() { openOrganizationModal(); };
            button.style.cssText = 'background-color: #28a745; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 16px; min-width: 40px;';
            button.title = 'Add New Organization';
            button.textContent = '+';
            
            // Add button to the span
            rcvrOrgSpan.appendChild(button);
            console.log('Custom organization button added back');
        }
    }
    
    // Run on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        ensureOrganizationButton();
        
        // Run again after delays to catch any async additions/modifications
        setTimeout(ensureOrganizationButton, 100);
        setTimeout(ensureOrganizationButton, 500);
        setTimeout(ensureOrganizationButton, 1000);
        setTimeout(ensureOrganizationButton, 2000);
    });
    
    // Also run immediately in case DOM is already loaded
    if (document.readyState === 'loading') {
        // DOM is still loading
    } else {
        // DOM is already loaded
        ensureOrganizationButton();
        setTimeout(ensureOrganizationButton, 100);
        setTimeout(ensureOrganizationButton, 500);
    }
    
    // Set up a MutationObserver to watch for changes
    window.addEventListener('load', function() {
        const rcvrOrgSpan = document.getElementById('rcvr_org_span');
        if (rcvrOrgSpan) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    // Check if nodes were added or removed
                    if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
                        // Ensure button is still there
                        setTimeout(ensureOrganizationButton, 50);
                    }
                    
                    // Remove any admin addlinks that were added
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            if (node.matches && node.matches('a.addlink[href*="/admin/"]')) {
                                console.log('MutationObserver: Removing dynamically added admin addlink');
                                node.remove();
                            }
                        }
                    });
                });
            });
            
            observer.observe(rcvrOrgSpan, {
                childList: true,
                subtree: true
            });
            
            // Run cleanup one more time after observer is set up
            ensureOrganizationButton();
        }
    });
    
    // Also check periodically (every 2 seconds) to ensure button stays
    setInterval(ensureOrganizationButton, 2000);
})();
</script>

{% if detail %}
<script>add_event_to_total()</script>
{% endif %}
{% endblock %}