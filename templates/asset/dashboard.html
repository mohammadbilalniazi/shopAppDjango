{% extends "master.html" %}
{% load static %}

{% block title %}Asset Dashboard - {{ selected_organization.name }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'assets/css/unified-styles.css' %}">
<style>
    .asset-dashboard {
        max-width: 1600px;
        margin: 20px auto;
        padding: 20px;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .dashboard-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
        font-weight: 700;
    }

    .dashboard-header select {
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        min-width: 300px;
    }

    .metric-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid;
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .metric-card.assets { border-left-color: #11998e; }
    .metric-card.liabilities { border-left-color: #eb3349; }
    .metric-card.equity { border-left-color: #667eea; }
    .metric-card.profit { border-left-color: #38ef7d; }

    .metric-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .metric-icon {
        float: right;
        font-size: 36px;
        opacity: 0.3;
    }

    .financial-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 30px;
    }

    .financial-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        font-size: 20px;
        font-weight: 600;
    }

    .section-body {
        padding: 25px;
    }

    .financial-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }

    .financial-row:last-child {
        border-bottom: none;
        padding-top: 15px;
        margin-top: 10px;
        border-top: 2px solid #667eea;
        font-weight: 700;
        font-size: 18px;
    }

    .financial-label {
        color: #555;
        font-weight: 500;
    }

    .financial-value {
        font-weight: 600;
        color: #2c3e50;
    }

    .financial-value.positive {
        color: #11998e;
    }

    .financial-value.negative {
        color: #eb3349;
    }

    .quick-actions {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-top: 30px;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .action-btn {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        color: white;
        padding: 12px 25px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        color: white;
    }

    .action-btn.secondary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .action-btn.secondary:hover {
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .refresh-btn {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
    }

    .refresh-btn:hover {
        box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="asset-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="bi bi-graph-up"></i> Financial Dashboard</h1>
        <form method="GET" id="org-filter-form">
            <select name="organization" class="searchable-dropdown" onchange="this.form.submit()">
                <option value="">Select Organization</option>
                {% for org in organizations %}
                    <option value="{{ org.id }}" {% if selected_organization.id == org.id %}selected{% endif %}>
                        {{ org.name }}
                    </option>
                {% endfor %}
            </select>
        </form>
        {% if selected_organization %}
            <p style="margin: 10px 0 0; opacity: 0.9;">
                Last Updated: {{ asset_summary.last_updated|date:"Y-m-d H:i" }}
            </p>
        {% endif %}
    </div>

    {% if selected_organization and asset_summary %}
        <!-- Key Metrics -->
        <div class="metric-cards">
            <div class="metric-card assets">
                <div class="metric-icon">üí∞</div>
                <div class="metric-label">Total Assets</div>
                <div class="metric-value">{{ asset_summary.total_assets|floatformat:2 }}</div>
                <small style="color: #11998e;">{{ asset_summary.currency|upper }}</small>
            </div>

            <div class="metric-card liabilities">
                <div class="metric-icon">üìä</div>
                <div class="metric-label">Total Liabilities</div>
                <div class="metric-value">{{ asset_summary.total_liabilities|floatformat:2 }}</div>
                <small style="color: #eb3349;">{{ asset_summary.currency|upper }}</small>
            </div>

            <div class="metric-card equity">
                <div class="metric-icon">üè¶</div>
                <div class="metric-label">Owner's Equity</div>
                <div class="metric-value">{{ asset_summary.equity|floatformat:2 }}</div>
                <small style="color: #667eea;">{{ asset_summary.currency|upper }}</small>
            </div>

            <div class="metric-card profit">
                <div class="metric-icon">üìà</div>
                <div class="metric-label">Net Profit</div>
                <div class="metric-value">{{ asset_summary.net_profit|floatformat:2 }}</div>
                <small style="color: {% if asset_summary.net_profit >= 0 %}#38ef7d{% else %}#eb3349{% endif %};">
                    {{ asset_summary.currency|upper }}
                </small>
            </div>
        </div>

        <!-- Financial Statements -->
        <div class="financial-sections">
            <!-- Balance Sheet Summary -->
            <div class="financial-section">
                <div class="section-header">
                    <i class="bi bi-clipboard-data"></i> Balance Sheet
                </div>
                <div class="section-body">
                    <div class="financial-row">
                        <span class="financial-label">Cash on Hand</span>
                        <span class="financial-value positive">{{ balance_sheet.assets.current_assets.cash|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Inventory Value</span>
                        <span class="financial-value">{{ balance_sheet.assets.current_assets.inventory|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Accounts Receivable</span>
                        <span class="financial-value">{{ balance_sheet.assets.current_assets.accounts_receivable|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Loans Receivable</span>
                        <span class="financial-value">{{ balance_sheet.assets.current_assets.loans_receivable|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Accounts Payable</span>
                        <span class="financial-value negative">{{ balance_sheet.liabilities.current_liabilities.accounts_payable|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Loans Payable</span>
                        <span class="financial-value negative">{{ balance_sheet.liabilities.current_liabilities.loans_payable|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Net Worth</span>
                        <span class="financial-value">{{ balance_sheet.equity.total_equity|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <!-- Profit & Loss Summary -->
            <div class="financial-section">
                <div class="section-header">
                    <i class="bi bi-bar-chart-line"></i> Profit & Loss
                </div>
                <div class="section-body">
                    <div class="financial-row">
                        <span class="financial-label">Revenue (Sales)</span>
                        <span class="financial-value positive">{{ profit_loss.revenue.total_revenue|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Cost of Goods Sold</span>
                        <span class="financial-value negative">{{ profit_loss.cost_of_sales.total_cogs|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Gross Profit</span>
                        <span class="financial-value">{{ profit_loss.gross_profit|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Operating Expenses</span>
                        <span class="financial-value negative">{{ profit_loss.operating_expenses.general_expenses|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Losses (Damage/Degrade)</span>
                        <span class="financial-value negative">{{ profit_loss.operating_expenses.losses_from_damage|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Net Profit</span>
                        <span class="financial-value {% if profit_loss.net_profit >= 0 %}positive{% else %}negative{% endif %}">
                            {{ profit_loss.net_profit|floatformat:2 }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Cash Flow Summary -->
            <div class="financial-section">
                <div class="section-header">
                    <i class="bi bi-cash-stack"></i> Cash Flow
                </div>
                <div class="section-body">
                    <div class="financial-row">
                        <span class="financial-label">Cash from Sales</span>
                        <span class="financial-value positive">{{ cash_flow.operating_activities.cash_from_sales|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Cash for Purchases</span>
                        <span class="financial-value negative">{{ cash_flow.operating_activities.cash_for_purchases|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Cash for Expenses</span>
                        <span class="financial-value negative">{{ cash_flow.operating_activities.cash_for_expenses|floatformat:2 }}</span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Operating Cash Flow</span>
                        <span class="financial-value {% if cash_flow.operating_activities.net_operating_cash >= 0 %}positive{% else %}negative{% endif %}">
                            {{ cash_flow.operating_activities.net_operating_cash|floatformat:2 }}
                        </span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Financing Cash Flow</span>
                        <span class="financial-value {% if cash_flow.financing_activities.net_financing_cash >= 0 %}positive{% else %}negative{% endif %}">
                            {{ cash_flow.financing_activities.net_financing_cash|floatformat:2 }}
                        </span>
                    </div>
                    <div class="financial-row">
                        <span class="financial-label">Net Cash Flow</span>
                        <span class="financial-value {% if cash_flow.net_cash_flow >= 0 %}positive{% else %}negative{% endif %}">
                            {{ cash_flow.net_cash_flow|floatformat:2 }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3 style="margin: 0 0 20px; color: #2c3e50;">
                <i class="bi bi-lightning-charge"></i> Quick Actions
            </h3>
            <div class="action-buttons">
                <a href="{% url 'balance_sheet' %}?organization={{ selected_organization.id }}" class="action-btn">
                    <i class="bi bi-file-earmark-text"></i> View Full Balance Sheet
                </a>
                <a href="{% url 'profit_loss' %}?organization={{ selected_organization.id }}" class="action-btn secondary">
                    <i class="bi bi-graph-up-arrow"></i> View Profit & Loss
                </a>
                <a href="{% url 'cash_flow' %}?organization={{ selected_organization.id }}" class="action-btn">
                    <i class="bi bi-cash-coin"></i> View Cash Flow
                </a>
                <a href="{% url 'loans' %}?organization={{ selected_organization.id }}" class="action-btn secondary">
                    <i class="bi bi-bank"></i> Manage Loans
                </a>
                <button onclick="refreshAssets()" class="action-btn refresh-btn" id="refresh-btn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info" style="margin: 40px 0; padding: 30px; text-align: center; font-size: 18px;">
            <i class="bi bi-info-circle" style="font-size: 48px; display: block; margin-bottom: 15px;"></i>
            Please select an organization to view its financial dashboard.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    // Initialize Select2 for organization dropdown
    $(document).ready(function() {
        $('.searchable-dropdown').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });
    });

    // Refresh assets
    async function refreshAssets() {
        const orgId = {{ selected_organization.id|default:0 }};
        if (!orgId) {
            alert('Please select an organization first');
            return;
        }

        const btn = document.getElementById('refresh-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';

        try {
            const response = await fetch('/asset/api/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ organization_id: orgId })
            });

            const data = await response.json();

            if (data.success) {
                alert('Assets refreshed successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error refreshing assets: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
