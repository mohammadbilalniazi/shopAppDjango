{% extends "master.html" %}
{% load static %}

{% block title %}Add Product {% endblock %}

{% block head_extra %}
<style>
    /* Modern Card Design for Product Form */
    .product-form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .product-form-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
    }
    
    .form-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 1rem;
    }
    
    .form-table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
    }
    
    .form-table td:first-child {
        font-weight: 600;
        color: #333;
        width: 200px;
    }
    
    .form-control-custom,
    .inputs,
    .form-table input[type="text"],
    .form-table input[type="number"],
    .form-table input[type="file"],
    .form-table select,
    .form-table textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .form-control-custom:focus,
    .inputs:focus,
    .form-table input:focus,
    .form-table select:focus,
    .form-table textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-table input:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
    }
    
    /* Checkbox Styling */
    .form-table input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 20px auto; padding: 20px;">
    
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == "error" %}
                <div class='alert alert-danger' style="background-color:#f8d7da;color:#721c24;font-weight:600;text-align:center;padding:12px;font-size:15px;border-radius:8px;margin-bottom:1rem;">
            {% else %}
                <div class='alert alert-success' style="background-color:#d4edda;color:#155724;font-weight:600;text-align:center;padding:12px;font-size:15px;border-radius:8px;margin-bottom:1rem;">
            {% endif %}
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Page Header -->
    <div class="product-form-header">
        <h1>{% if product %}✏️ Update Product{% else %}➕ Add Product{% endif %}</h1>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Fill in the product information below</p>
    </div>

    <!-- Form Card -->
    <div class="form-card">
        <form method="post" id="product_form" action='{{request.META.HTTP_NAME}}/product/product_form/create/{{id}}' enctype="multipart/form-data">                  
            {% csrf_token %}  
            
            <table class="form-table">
                <tr>
                    <td>Is Service</td>
                    <td colspan="2">
                        <input name="is_service" checked type="checkbox" id="is_service">
                    </td>
                </tr>
                
                <tr>
                    <td>System Id</td>
                    <td colspan="2">
                        {{product.id}}
                        <input type="hidden" class="inputs" name="id" disabled id="id" value='{{product.id}}'>
                    </td>
                </tr>
                
                <tr>
                    <td>Item Name</td>
                    <td colspan="2">
                        <input type="text" class="form-control-custom" name="item_name" id="item_name" {% if product %} value="{{product.item_name}}" {% endif %}>
                    </td>
                </tr>

                <tr>
                    <td>Category</td>
                    <td colspan="2">
                        <select name="category" class="form-control-custom" id="category">
                            {% for category in categories %}
                                <option {% if product.category == category.id %} selected {% endif %} value='{{category.id}}'>{{category}}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                
                <tr>
                    <td>Organization</td>
                    <td colspan="2">
                        <select name="organization" class="form-control-custom organization-select" id="organization">
                            <option value="">Select Organization</option>
                            {% if organizations %}
                                {% for org in organizations %}
                                    <option {% if product and org.id == product.organization.id %} selected {% endif %} value='{{org.id}}'>{{org}}</option>
                                {% endfor %}
                            {% elif global_organizations %}
                                {% for org in global_organizations %}
                                    <option {% if product and org.id == product.organization.id %} selected {% endif %} value='{{org.id}}'>{{org.name}}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </td>
                </tr>
                
                <tr>
                    <td>Product Image</td>
                    <td colspan="2">
                        <input type="file" class="form-control-custom" name="img" id="img">
                    </td>
                </tr>
                
                <tr>
                    <td>Model</td>
                    <td colspan="2">
                        <input type="text" class="form-control-custom" name="model" id="model" value="{{product.model}}" required="">
                    </td>
                </tr>
                
                <tr>
                    <td>Minimum Requirement</td>
                    <td colspan="2">
                        <input type="number" class="form-control-custom" id="minimum_requirement" {% if product %} value="{{product.product_detail.minimum_requirement}}" {% else %} value=1 {% endif %} name="minimum_requirement">
                    </td>
                </tr>
                
                <tr>
                    <td>Current Amount Available</td>
                    <td colspan="2">
                        <input type="number" class="form-control-custom" disabled {% if product %} value="{{current_amount}}" {% else %} value=0 {% endif %} id="current_amount" name="current_amount">
                    </td>
                </tr>
                
                <tr>
                    <td>Current Purchased Price</td>
                    <td colspan="2">
                        <input type="number" step=".001" class="form-control-custom" required id="purchased_price" value="{{product.product_detail.purchased_price}}" name="purchased_price">
                    </td>
                </tr>
                
                <tr>
                    <td>Current Selling Price</td>
                    <td colspan="2">
                        <input type="number" step=".001" class="form-control-custom" value='{{product.product_detail.selling_price}}' required id="selling_price" name="selling_price">
                    </td>
                </tr>
                
                <tr>
                    <td></td>
                    <td colspan="2" style="text-align: right; padding-top: 2rem;">
                        <input type="submit" id='form_submit_btn' {% if product %} value="✓ Update Product" {% else %} value="➕ Add Product" {% endif %} class="btn-success-gradient" name="save" style="min-width: 200px; cursor: pointer;">
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'assets/js/axios.min.js' %}"></script>
<script src="{% static 'assets/js/cookie.js' %}"></script>
<script src="{% static 'assets/js/common_entities/create_element.js' %}"></script>
<script src="{% static 'assets/js/show_message.js' %}"></script>
<script src="{% static 'assets/js/common_entities/call_shirkat.js' %}"></script>
<script src="{% static 'assets/js/configuration/organization.js' %}"></script>
<script src="{% static 'assets/js/product/product.js' %}"></script>
<script>
async function get_products()
 {
    url='/products/'+"all"+"/";
    let response=await call_shirkat(url,'GET');
    localStorage.setItem("product_data",JSON.stringify(response.data));
    let product_data=JSON.parse(localStorage.getItem("product_data"));
    let selling_price_obj={};   
    let purchasing_price_obj={};
    for (const key in product_data) {
        let product = product_data[key];
        if (product.product_detail) {
            selling_price_obj[product.id] = product.product_detail.selling_price;
            purchasing_price_obj[product.id] = product.product_detail.purchased_price;
        } else {
            product_data[key]['product_detail'] = { selling_price: 0, purchased_price: 0, minimum_requirement: 0 };
            selling_price_obj[product.id] = 0;
            purchasing_price_obj[product.id] = 0;
        }
    }
    localStorage.setItem("selling_price_obj",JSON.stringify(selling_price_obj));
    localStorage.setItem("purchasing_price_obj",JSON.stringify(purchasing_price_obj));
 }
 get_products();
var product_form=document.getElementById('product_form');
product_form.addEventListener("submit",async function(e){
    e.preventDefault();
    id=document.getElementById("id");
    console.log("product_form ",product_form.action) 
    if(id.value=="")
    {
        id.value=null;
    }
    item_name=document.getElementById('item_name');
    category=document.getElementById("category");
    organization=document.getElementById("organization");
    img=document.getElementById("img");
    console.log("img ",img.files[0])
    model=document.getElementById("model");
    minimum_requirement=document.getElementById("minimum_requirement");
    is_service=document.getElementById("is_service");
    current_amount=document.getElementById("current_amount");    
    purchased_price=document.getElementById("purchased_price");
    // prev_purchased_price=document.getElementById("prev_purchased_price");
    selling_price=document.getElementById("selling_price");
    // prev_selling_price=document.getElementById("prev_selling_price");
    // const product = new FormData();
    const formData=new FormData();
    
    formData.append("id",id.value);
    formData.append("item_name",item_name.value);
    formData.append("category",category.value);
    formData.append("organization",organization.value);
    formData.append("img",img.files[0]);
    formData.append("is_service",is_service.value);
    formData.append("model",model.value);
    formData.append("minimum_requirement",minimum_requirement.value);
    formData.append("current_amount",current_amount.value);
    formData.append("purchased_price",purchased_price.value);
    // formData.append("prev_purchased_price",prev_purchased_price.value);
    formData.append("selling_price",selling_price.value);
    // formData.append("prev_selling_price",prev_selling_price.value);
    url=product_form.action;
    headers={'Content-Type': 'multipart/form-data','X-CSRFToken':getCookie('csrftoken')} 
    const response=await call_shirkat(url,'POST',formData,headers);
    console.log('res ',response)
     if(response.status==200 || response.status==201){
        if(response.data.ok)
        { 
            alert("Product Saved")
            id.value=response.data.id;
            window.location.href="/products/product/add/"+id.value;
        }
        else
        {
            show_message(response.data.message,"error");   
        }
    }
    else{
        show_message("bill Not Created ","error")
    }
    return false;
});
</script>
<script>
document.getElementById("purchased_price").addEventListener("change",(e)=>{
        let purchased_price= e.target.value;
        if(purchased_price==null || purchased_price=="" || purchased_price==0){
            purchased_price=0;
        }
        document.getElementById("selling_price").value=parseInt(purchased_price)+50;
    });

    document.getElementById("item_name").addEventListener("change",(e)=>{
        let item_name= e.target.value;
        if(item_name==null || item_name=="" || item_name==0){
            item_name="";
        }
        document.getElementById("model").value=item_name.split(" ")[0];
    })
</script>
<script>
const search_by_org=true;
    search_product(null,search_by_org);
     item_name.addEventListener("input",(e)=>{
         search_product(null,search_by_org);
     });
</script>
{% endblock %}
